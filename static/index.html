<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="icon.webp"/>
    <title>文件上传</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        progress {
            width: 300px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" multiple>
        <input type="password" id="password" placeholder="请输入上传密码" class="hidden">
        <button type="submit">上传</button>
    </form>
    <progress id="progress" value="0" max="100"></progress>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // 检查是否选择了文件
            const fileInput = document.querySelector('input[type="file"]');
            if (fileInput.files.length === 0) {
                alert("请选择要上传的文件！");
                return;
            }

            // 显示密码输入框
            const passwordInput = document.getElementById('password');
            if (passwordInput.classList.contains('hidden')) {
                passwordInput.classList.remove('hidden');
                passwordInput.focus();
                return;
            }

            // 检查密码是否为空
            const password = passwordInput.value;
            if (!password) {
                alert("密码不能为空！");
                return;
            }

            // 构造表单数据
            const formData = new FormData(this);
            formData.append("password", password);

            // 使用XMLHttpRequest上传文件并显示进度
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            // 监听上传进度
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    document.getElementById('progress').value = percent;
                }
            };

            // 上传完成后的回调
            xhr.onload = function() {
                if (xhr.status === 200) {
                    alert('上传成功：' + xhr.responseText);
                    document.getElementById('progress').value = 0; // 重置进度条
                } else if (xhr.status === 403) {
                    alert('密码错误');
                } else {
                    alert('上传失败：' + xhr.responseText);
                }
            };

            xhr.send(formData);
        });
    </script>
</body>
</html>
